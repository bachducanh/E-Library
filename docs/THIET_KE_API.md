# 4. THIáº¾T Káº¾ API & LUá»’NG NGHIá»†P Vá»¤

## 4.1. API Architecture

### 4.1.1. Technology Stack

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Client (Browser / Mobile App)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ HTTPS/REST
              â”‚ JSON payloads
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      FastAPI Application             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  CORS Middleware               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                â”‚                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  JWT Auth Middleware           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                â”‚                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  API Routers                   â”‚  â”‚
â”‚  â”‚  â€¢ /auth   (Authentication)    â”‚  â”‚
â”‚  â”‚  â€¢ /books  (Catalog & Search)  â”‚  â”‚
â”‚  â”‚  â€¢ /loans  (Borrow & Return)   â”‚  â”‚
â”‚  â”‚  â€¢ /stats  (Analytics)         â”‚  â”‚
â”‚  â”‚  â€¢ /users  (User Management)   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                â”‚                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Business Logic Layer          â”‚  â”‚
â”‚  â”‚  â€¢ Validation (Pydantic)       â”‚  â”‚
â”‚  â”‚  â€¢ Authorization (RBAC)        â”‚  â”‚
â”‚  â”‚  â€¢ Transaction Handling        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                â”‚                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Database Layer (Motor)        â”‚  â”‚
â”‚  â”‚  â€¢ Async MongoDB Driver        â”‚  â”‚
â”‚  â”‚  â€¢ Connection Pooling          â”‚  â”‚
â”‚  â”‚  â€¢ Query Building              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  MongoDB Cluster       â”‚
    â”‚  (mongos1:27020)       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.1.2. API Endpoints Summary

| Category | Endpoint | Method | Auth Required | Description |
|----------|----------|--------|---------------|-------------|
| **Auth** | `/auth/register` | POST | âŒ | ÄÄƒng kÃ½ tÃ i khoáº£n má»›i |
| | `/auth/login` | POST | âŒ | ÄÄƒng nháº­p â†’ JWT token |
| | `/auth/me` | GET | âœ… | ThÃ´ng tin user hiá»‡n táº¡i |
| **Books** | `/books/search?q={query}` | GET | âœ… | TÃ¬m kiáº¿m full-text |
| | `/books/` | GET | âœ… | Danh sÃ¡ch sÃ¡ch (pagination) |
| | `/books/{id}` | GET | âœ… | Chi tiáº¿t 1 sÃ¡ch |
| | `/books/{id}/copies` | GET | âœ… | Báº£n sao váº­t lÃ½ |
| | `/books/categories/list` | GET | âœ… | Danh sÃ¡ch categories |
| **Loans** | `/loans/borrow` | POST | âœ… | MÆ°á»£n sÃ¡ch |
| | `/loans/return/{id}` | POST | âœ… | Tráº£ sÃ¡ch |
| | `/loans/my-loans` | GET | âœ… | SÃ¡ch Ä‘ang mÆ°á»£n |
| **Stats** | `/stats/dashboard` | GET | âœ… | Tá»•ng quan dashboard |
| | `/stats/books-by-category` | GET | âœ… | PhÃ¢n bá»‘ theo category |
| | `/stats/loans-by-branch` | GET | âœ… | Thá»‘ng kÃª theo chi nhÃ¡nh |
| | `/stats/transaction-trends` | GET | âœ… | Xu hÆ°á»›ng giao dá»‹ch |
| **Users** | `/users/` | GET | âœ… ADMIN | Danh sÃ¡ch users |
| | `/users/{id}` | GET | âœ… | Profile user |
| | `/users/{id}` | PUT | âœ… | Cáº­p nháº­t profile |

## 4.2. Authentication & Authorization

### 4.2.1. JWT Authentication Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚
     â”‚ 1. POST /auth/login
     â”‚    { email, password }
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Auth Router    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 2. Verify credentials
     â”‚    - Find user by email
     â”‚    - bcrypt.checkpw(password, hash)
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Security Utils  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 3. Generate JWT
     â”‚    - Payload: { sub: userId, role: "MEMBER" }
     â”‚    - Expiry: 24 hours
     â”‚    - Sign with SECRET_KEY
     â–¼
     â”‚ 4. Return token
     â”‚    { access_token: "eyJhbGc...", token_type: "bearer" }
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client  â”‚ 5. Store token in localStorage
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚
     â”‚ 6. Subsequent requests
     â”‚    Header: Authorization: Bearer eyJhbGc...
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Auth Middleware â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 7. Decode & verify token
     â”‚    - Check expiry
     â”‚    - Verify signature
     â”‚    - Extract user_id
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Get User from DBâ”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 8. Attach user to request
     â”‚    request.state.current_user = user_doc
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Route Handler   â”‚ 9. Access current_user
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2.2. Password Security

**Hashing vá»›i bcrypt:**
```python
import bcrypt

# Registration - Hash password
def hash_password(password: str) -> str:
    salt = bcrypt.gensalt(rounds=12)  # Cost factor: 12
    hashed = bcrypt.hashpw(password.encode('utf-8'), salt)
    return hashed.decode('utf-8')

# Login - Verify password
def verify_password(plain: str, hashed: str) -> bool:
    return bcrypt.checkpw(
        plain.encode('utf-8'),
        hashed.encode('utf-8')
    )
```

**Táº¡i sao bcrypt?**
| Feature | bcrypt | MD5 | SHA256 |
|---------|--------|-----|---------|
| **Slow by design** | âœ… | âŒ | âŒ |
| **Adaptive cost** | âœ… (rounds) | âŒ | âŒ |
| **Salt included** | âœ… Auto | âŒ Manual | âŒ Manual |
| **Resist brute-force** | âœ… | âŒ | âš ï¸ |
| **Industry standard** | âœ… | âŒ Deprecated | âš ï¸ Not for passwords |

**Security Parameters:**
```python
Cost Factor: 12 (2^12 = 4096 iterations)
Hash Time: ~100-300ms per password
Rainbow Table: Infeasible (unique salt per password)
```

### 4.2.3. Role-Based Access Control (RBAC)

**Roles:**

| Role | Permissions | Use Case |
|------|-------------|----------|
| **MEMBER** | - TÃ¬m kiáº¿m sÃ¡ch<br>- MÆ°á»£n/tráº£ sÃ¡ch (cá»§a mÃ¬nh)<br>- Xem profile (cá»§a mÃ¬nh)<br>- Xem my-loans | ThÃ nh viÃªn thÃ´ng thÆ°á»ng |
| **STAFF** | - All MEMBER permissions<br>- Tráº£ sÃ¡ch cho members<br>- Xem loans cá»§a branch<br>- Cáº­p nháº­t copy status | NhÃ¢n viÃªn thÆ° viá»‡n |
| **ADMIN** | - All STAFF permissions<br>- User management<br>- System statistics<br>- Branch management | Quáº£n trá»‹ viÃªn |

**Implementation:**
```python
from fastapi import Depends, HTTPException

def require_role(allowed_roles: list[str]):
    async def check_role(current_user = Depends(get_current_user)):
        if current_user["role"] not in allowed_roles:
            raise HTTPException(
                status_code=403,
                detail="Insufficient permissions"
            )
        return current_user
    return check_role

# Usage:
@router.get("/admin/users")
async def get_all_users(
    current_user = Depends(require_role(["ADMIN"]))
):
    # Only ADMIN can access
    pass
```

## 4.3. Luá»“ng Nghiá»‡p Vá»¥ ChÃ­nh

### 4.3.1. LUá»’NG MÆ¯á»¢N SÃCH (Atomic Transaction)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  POST /loans/borrow                                          â”‚
â”‚  Body: { copyId: "CP000123" }                                â”‚
â”‚  Headers: { Authorization: "Bearer <token>" }                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 1: Authentication & Authorization                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ Verify JWT token                                          â”‚
â”‚  â€¢ Extract current_user from database                        â”‚
â”‚  â€¢ Check user.status == "active"                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ âœ… User authenticated
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 2: Subscription Validation                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  IF user.subscription.endDate < now():                       â”‚
â”‚    âŒ REJECT: "Subscription expired"                         â”‚
â”‚                                                              â”‚
â”‚  active_loans = count({ memberId, status: "active|overdue" })â”‚
â”‚  IF active_loans >= user.subscription.maxLoans:              â”‚
â”‚    âŒ REJECT: "Max loans reached (BASIC: 3, VIP: 10)"       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ âœ… Subscription valid
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 3: Copy Availability Check                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  copy = db.copies.find_one({ _id: copyId })                  â”‚
â”‚                                                              â”‚
â”‚  IF copy == null:                                            â”‚
â”‚    âŒ REJECT: "Copy not found"                               â”‚
â”‚                                                              â”‚
â”‚  IF copy.status != "available":                              â”‚
â”‚    âŒ REJECT: "Copy is borrowed/maintenance"                 â”‚
â”‚                                                              â”‚
â”‚  IF copy.branchId != user.branchId:                          â”‚
â”‚    âŒ REJECT: "Copy only at {copy.branchId} branch"          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ âœ… Copy available
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 4: Create Loan Record (ATOMIC)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  loan = {                                                     â”‚
â”‚    _id: "LN" + sequential_id(),                              â”‚
â”‚    branchId: user.branchId,        // ğŸ”‘ Shard key           â”‚
â”‚    memberId: user._id,                                       â”‚
â”‚    copyId: copy._id,                                         â”‚
â”‚    bookId: copy.bookId,                                      â”‚
â”‚    borrowedAt: now(),              // ğŸ”‘ Shard key           â”‚
â”‚    dueAt: now() + subscription.loanDuration days,            â”‚
â”‚    status: "active"                                          â”‚
â”‚  }                                                           â”‚
â”‚                                                              â”‚
â”‚  result = db.loans.insert_one(loan)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ âœ… Loan created
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 5: Update Copy Status (ATOMIC)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  db.copies.update_one(                                       â”‚
â”‚    { _id: copyId },                                          â”‚
â”‚    { $set: { status: "borrowed" } }                          â”‚
â”‚  )                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ âœ… Copy status updated
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 6: Create Transaction Log (ATOMIC)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  transaction = {                                             â”‚
â”‚    _id: "TX" + sequential_id(),                              â”‚
â”‚    branchId: user.branchId,        // ğŸ”‘ Shard key           â”‚
â”‚    type: "borrow",                                           â”‚
â”‚    memberId: user._id,                                       â”‚
â”‚    copyId: copy._id,                                         â”‚
â”‚    loanId: loan._id,                                         â”‚
â”‚    createdAt: now()                // ğŸ”‘ Shard key           â”‚
â”‚  }                                                           â”‚
â”‚                                                              â”‚
â”‚  db.transactions.insert_one(transaction)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ âœ… Transaction logged
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 7: Return Success Response                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  {                                                           â”‚
â”‚    "loan": {                                                 â”‚
â”‚      "_id": "LN000123",                                      â”‚
â”‚      "copyId": "CP000123",                                   â”‚
â”‚      "borrowedAt": "2024-01-11T10:30:00Z",                   â”‚
â”‚      "dueAt": "2024-02-10T10:30:00Z",                        â”‚
â”‚      "status": "active"                                      â”‚
â”‚    }                                                         â”‚
â”‚  }                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Táº¡i sao khÃ´ng dÃ¹ng MongoDB Transaction?**

MongoDB Sharded Cluster há»— trá»£ multi-document transactions, nhÆ°ng:

âŒ **KhÃ´ng cáº§n thiáº¿t** vÃ¬:
- Má»—i operation (insert loan, update copy, insert transaction) lÃ  atomic
- Thá»© tá»± operations Ä‘Æ°á»£c Ä‘áº£m báº£o trong async/await
- Failure á»Ÿ giá»¯a cÃ³ thá»ƒ rollback manually

âŒ **Performance overhead:**
- Distributed transactions cháº­m hÆ¡n
- Requires distributed coordinator
- Locks nhiá»u shards

âœ… **Alternative approach - Compensating Transactions:**
```python
try:
    # Step 1: Create loan
    loan_id = await db.loans.insert_one(loan_doc)
    
    # Step 2: Update copy
    await db.copies.update_one(...)
    
    # Step 3: Log transaction
    await db.transactions.insert_one(...)
    
except Exception as e:
    # Rollback: Delete loan if created
    if loan_id:
        await db.loans.delete_one({"_id": loan_id})
    raise HTTPException(500, "Transaction failed")
```

### 4.3.2. LUá»’NG TRáº¢ SÃCH

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  POST /loans/return/{loan_id}                                â”‚
â”‚  Headers: { Authorization: "Bearer <token>" }                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 1: Find & Validate Loan                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  loan = db.loans.find_one({ _id: loan_id })                  â”‚
â”‚                                                              â”‚
â”‚  IF loan == null:                                            â”‚
â”‚    âŒ REJECT: "Loan not found"                               â”‚
â”‚                                                              â”‚
â”‚  IF loan.status == "returned":                               â”‚
â”‚    âŒ REJECT: "Book already returned"                        â”‚
â”‚                                                              â”‚
â”‚  IF loan.memberId != current_user._id AND                    â”‚
â”‚     current_user.role NOT IN ["STAFF", "ADMIN"]:             â”‚
â”‚    âŒ REJECT: "Not authorized"                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ âœ… Loan valid
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 2: Calculate Fine (if overdue)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  return_date = now()                                         â”‚
â”‚  overdue_days = 0                                            â”‚
â”‚  fine_amount = 0                                             â”‚
â”‚                                                              â”‚
â”‚  IF return_date > loan.dueAt:                                â”‚
â”‚    overdue_days = (return_date - loan.dueAt).days            â”‚
â”‚    fine_amount = overdue_days * 5000  // 5000 VND per day    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 3: Update Loan Status                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  db.loans.update_one(                                        â”‚
â”‚    { _id: loan_id },                                         â”‚
â”‚    { $set: {                                                 â”‚
â”‚        returnedAt: return_date,                              â”‚
â”‚        status: "returned",                                   â”‚
â”‚        overdueDays: overdue_days,                            â”‚
â”‚        fineAmount: fine_amount                               â”‚
â”‚      }                                                       â”‚
â”‚    }                                                         â”‚
â”‚  )                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 4: Update Copy Status                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  db.copies.update_one(                                       â”‚
â”‚    { _id: loan.copyId },                                     â”‚
â”‚    { $set: { status: "available" } }                         â”‚
â”‚  )                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 5: Log Return Transaction                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  db.transactions.insert_one({                                â”‚
â”‚    type: "return",                                           â”‚
â”‚    branchId: loan.branchId,                                  â”‚
â”‚    memberId: loan.memberId,                                  â”‚
â”‚    loanId: loan_id,                                          â”‚
â”‚    createdAt: return_date                                    â”‚
â”‚  })                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 6: Create Fine Transaction (if applicable)             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  IF fine_amount > 0:                                         â”‚
â”‚    db.transactions.insert_one({                              â”‚
â”‚      type: "fine",                                           â”‚
â”‚      branchId: loan.branchId,                                â”‚
â”‚      memberId: loan.memberId,                                â”‚
â”‚      loanId: loan_id,                                        â”‚
â”‚      amount: fine_amount,                                    â”‚
â”‚      description: f"Overdue {overdue_days} days",            â”‚
â”‚      status: "pending",                                      â”‚
â”‚      createdAt: return_date                                  â”‚
â”‚    })                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 7: Return Response                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  {                                                           â”‚
â”‚    "loan": {                                                 â”‚
â”‚      "_id": "LN000123",                                      â”‚
â”‚      "returnedAt": "2024-01-15T14:20:00Z",                   â”‚
â”‚      "status": "returned",                                   â”‚
â”‚      "overdueDays": 3,                                       â”‚
â”‚      "fineAmount": 15000                                     â”‚
â”‚    }                                                         â”‚
â”‚  }                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3.3. LUá»’NG TÃŒM KIáº¾M SÃCH

```
GET /books/search?q=distributed%20systems

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MongoDB Query vá»›i Text Index          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  db.books.find(                        â”‚
â”‚    { $text: { $search: "distributed    â”‚
â”‚                        systems" } },   â”‚
â”‚    { score: { $meta: "textScore" } }   â”‚
â”‚  ).sort([                              â”‚
â”‚    ("score", { $meta: "textScore" })   â”‚
â”‚  ]).limit(50)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Text Index Processing                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. Tokenize: ["distributed", "systems"]â”‚
â”‚  2. Stem words (if configured)         â”‚
â”‚  3. Search inverted index:             â”‚
â”‚                                        â”‚
â”‚     "distributed" â†’ [BK001, BK045, ...]â”‚
â”‚     "systems" â†’ [BK001, BK023, ...]    â”‚
â”‚                                        â”‚
â”‚  4. Calculate relevance score:         â”‚
â”‚     - Term frequency (TF)              â”‚
â”‚     - Inverse document frequency (IDF) â”‚
â”‚     - Field weights (title: 10, ...)   â”‚
â”‚                                        â”‚
â”‚  5. Rank results by score              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Results (sorted by relevance)         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [                                     â”‚
â”‚    {                                   â”‚
â”‚      _id: "BK001",                     â”‚
â”‚      title: "Distributed Systems",     â”‚
â”‚      score: 8.5                        â”‚
â”‚    },                                  â”‚
â”‚    {                                   â”‚
â”‚      _id: "BK045",                     â”‚
â”‚      title: "Computer Systems",        â”‚
â”‚      score: 3.2                        â”‚
â”‚    }                                   â”‚
â”‚  ]                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 4.4. API Request/Response Examples

### 4.4.1. Register

**Request:**
```http
POST /auth/register HTTP/1.1
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "SecurePass123!",
  "name": "Nguyá»…n VÄƒn A",
  "branchId": "HN"
}
```

**Response:**
```json
{
  "user": {
    "_id": "MB001234",
    "email": "user@example.com",
    "name": "Nguyá»…n VÄƒn A",
    "branchId": "HN",
    "role": "MEMBER",
    "subscription": {
      "type": "BASIC",
      "maxLoans": 3,
      "loanDuration": 14
    }
  },
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer"
}
```

### 4.4.2. Login

**Request:**
```http
POST /auth/login HTTP/1.1
Content-Type: application/json

{
  "email": "admin@elibrary.vn",
  "password": "admin123"
}
```

**Response:**
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJNQjAwMDAwMSIsInJvbGUiOiJBRE1JTiIsImV4cCI6MTY0MjAxNTIwMH0.abc123",
  "token_type": "bearer",
  "user": {
    "_id": "MB000001",
    "email": "admin@elibrary.vn",
    "name": "System Administrator",
    "role": "ADMIN"
  }
}
```

### 4.4.3. Search Books

**Request:**
```http
GET /books/search?q=technology&limit=10 HTTP/1.1
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

**Response:**
```json
[
  {
    "_id": "BK000123",
    "title": "Modern Technology Trends",
    "authors": ["John Doe", "Jane Smith"],
    "publisher": "Tech Publishing",
    "publishYear": 2023,
    "lccCode": "T58",
    "lccName": "Technology",
    "subjects": ["Technology", "Innovation", "Future"],
    "score": 8.5
  },
  {
    "_id": "BK000456",
    "title": "Computer Science and Technology",
    "authors": ["Alice Johnson"],
    "score": 6.2
  }
]
```

### 4.4.4. Borrow Book

**Request:**
```http
POST /loans/borrow HTTP/1.1
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Content-Type: application/json

{
  "copyId": "CP001234"
}
```

**Response:**
```json
{
  "_id": "LN005678",
  "branchId": "HN",
  "memberId": "MB000123",
  "copyId": "CP001234",
  "bookId": "BK000123",
  "borrowedAt": "2024-01-11T10:30:00Z",
  "dueAt": "2024-02-10T10:30:00Z",
  "status": "active",
  "renewCount": 0
}
```

---

**Tiáº¿p theo:** [Báº£o Máº­t](#5-báº£o-máº­t)
